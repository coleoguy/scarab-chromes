az <- st_as_sf(az, coords = c('x','y'), crs = 4326)
az <- set_bbox_side_length(az, 1000000)
az_output_tiles <- get_tiles(az, services = c('elevation', 'ortho'), resolution = 30)
az <- set_bbox_side_length(az, 400000)
az <- data.frame(110.825304,33.371061)
colnames(az) <- c('x','y')
az <- st_as_sf(az, coords = c('x','y'), crs = 4326)
az <- set_bbox_side_length(az, 400000)
az_output_tiles <- get_tiles(az, services = c('elevation', 'ortho'), resolution = 30)
az <- set_bbox_side_length(az, 300000)
az <- data.frame(110.825304,33.371061)
colnames(az) <- c('x','y')
az <- st_as_sf(az, coords = c('x','y'), crs = 4326)
az <- set_bbox_side_length(az, 300000)
az_output_tiles <- get_tiles(az, services = c('elevation', 'ortho'), resolution = 30)
az <- data.frame(110.825304,33.371061)
colnames(az) <- c('x','y')
az <- st_as_sf(az, coords = c('x','y'), crs = 4326)
az <- set_bbox_side_length(az, 200000)
az_output_tiles <- get_tiles(az, services = c('elevation', 'ortho'), resolution = 30)
sky_islands <- data.frame(-110.065780,32.117666)
colnames(sky_islands) <- c('x','y')
sky_islands <- st_as_sf(sky_islands, coords = c('x','y'), crs = 4326)
sky_islands <- set_bbox_side_length(sky_islands, 100000)
output_tiles <- get_tiles(sky_islands, services = c('elevation', 'ortho'), resolution = 30)
sky_islands <- data.frame(-110.065780,32.117666)
colnames(sky_islands) <- c('x','y')
sky_islands <- st_as_sf(sky_islands, coords = c('x','y'), crs = 4326)
sky_islands <- set_bbox_side_length(sky_islands, 100000)
output_tiles <- get_tiles(sky_islands, services = c('elevation', 'ortho'), resolution = 30)
# making map of skyisands
library(terrainr)
library(sf)
sky_islands <- data.frame(-110.065780,32.117666)
colnames(sky_islands) <- c('x','y')
sky_islands <- st_as_sf(sky_islands, coords = c('x','y'), crs = 4326)
sky_islands <- set_bbox_side_length(sky_islands, 100000)
output_tiles <- get_tiles(sky_islands, services = c('elevation', 'ortho'), resolution = 30)
# genetic drift effec on population size
n = 10
gen = 1000
a1 = 0.5
a2 = 1-a1
n*2
n*2
toallel <- n*2
a1 * toallel
a2 * toallel
# propotion of SA-fusion
library(devtools)
install_github('coleoguy/evobir', build_vignettes=T)
remove.packages("evobiR", lib="~/Library/R/arm64/4.5/library")
install_github('coleoguy/evobir', build_vignettes=T)
install_github('coleoguy/evobir', build_vignettes=T)
library(elevatr)
library(rayshader)
library(rayshader)
library(rayrender)
library(rayimage)
library(raster)
library(rappdirs)
library(rapidjsonr)
library(ragg)
library(quantreg)
library(quadprog)
library(purrr)
library(ggtreeExtra)
install.packages("ggtreeExtra")
setwd("~/Documents/GitHub/scarab-chromes/scripts")
library(chromePlus)
library(diversitree)
library(phytools)
library(viridis)
library(coda)
library(devtools)
install_github('coleoguy/evobir')
library(evobiR)
library(ape)
source('functions.R')
allchrom <- read.csv('../data/SpeciesChromList.csv')
trees <- read.tree("../data/final100trees")
# tree tips
fam <- c()
for (i in 1: length(trees[[1]]$tip.label)){
if (trees[[1]]$tip.label[i] %in% allchrom$Name){
fam <- c(fam,print(allchrom$Family[which(allchrom$Name == trees[[1]]$tip.label[i] )[1]]))
}
}
# family count
sum(fam == 'Scarabaeidae')
sum(fam == 'Lucanidae')
sum(fam == 'Passalidae')
# genus level count
length(trees[[1]]$tip.label) - length(grep('_', trees[[1]]$tip.label))
####################################
# exlude genus level taxa analysis #
# subtrees
trees <- read.tree('../data/final100trees')
allchrom <- read.csv('../data/SpeciesChromList.csv')
sca.tip <- c()
luc.tip <- c()
pas.tip <- c()
tip.names <- trees[[1]]$tip.label
tip.names <- tip.names[grepl('_', tip.names)] # species level only
for (i in 1:length(tip.names)){
if (tip.names[i] %in% allchrom$Name){
if (allchrom$Family[which(allchrom$Name == tip.names[i])[1]] == "Scarabaeidae"){
sca.tip <- c(sca.tip, tip.names[i])
}
if (allchrom$Family[which(allchrom$Name == tip.names[i])[1]] == "Lucanidae"){
luc.tip <- c(luc.tip, tip.names[i])
}
if (allchrom$Family[which(allchrom$Name == tip.names[i])[1]] == "Passalidae"){
pas.tip <- c(pas.tip, tip.names[i])
}
}
}
# create sub trees
sca.tree <- keep.tip.multiPhylo(trees, sca.tip)
luc.tree <- keep.tip.multiPhylo(trees, luc.tip)
pas.tree <- keep.tip.multiPhylo(trees, pas.tip)
####################
# subtree analyses #
iter <- 100
prior <- make.prior.exponential(r = 2)
sub <- c('sca','luc','pas')
all_luc <- read.csv('../results/sub_species_level_luc.csv')
all_pass <- read.csv('../results/sub_species_level_pas.csv')
all_sca <- read.csv('../results/sub_species_level_sca.csv')
# post burnin
sub_luc <- all_luc[all_luc$i == c(51:100),]
sub_pass <- all_pass[all_pass$i == c(51:100),]
sub_sca <- all_sca[all_sca$i == c(51:100),]
### desc ###
cols <- viridis(3, option = 'D',alpha = 0.7, begin = 0.45)
hpdcols <- viridis(3, option = 'D', begin = 0.45)
plot(density(sub_sca$desc1),main ='',xlab='Fusion (MY)',
xlim= c(0,0.09), ylim =c(-10,260))
title(main = "(A)", adj = 0, line = 0.5)
polygon(density(sub_sca$desc1),col=cols[1])
hpd <- HPDinterval(as.mcmc(sub_sca$desc))
y <- -5
lines(y=c(y,y), x=hpd[1:2], lwd=2,col=hpdcols[1])
lines(density((sub_luc$desc1)))
polygon(density(sub_luc$desc1),col=cols[2])
hpd <- HPDinterval(as.mcmc(sub_luc$desc))
y <- -10
lines(y=c(y,y), x=hpd[1:2], lwd=2,col=hpdcols[2])
lines(density((sub_pass$desc1)))
polygon(density(sub_pass$desc1),col=cols[3])
hpd <- HPDinterval(as.mcmc(sub_pass$desc))
y <-  -15
lines(y=c(y,y), x=hpd[1:2], lwd=2,col=hpdcols[3])
x = 0.07
cex = 1.2
points(x=x,y=260, col = hpdcols[1], pch= 16, cex = cex )
text(x=x,y=260,pos= 4, "Scarabaeidae")
points(x=x,y=245, col = hpdcols[2], pch= 16, cex = cex)
text(x=x,y=245,pos= 4, "Lucanidae")
points(x=x,y=230, col = hpdcols[3], pch= 16, cex = cex)
text(x=x,y=230,pos= 4, "Passalidae")
# save as PDF 6x6
### asc (fission) ###
# scarab
cols <- viridis(3, option = 'D',alpha = 0.7, begin = 0.45)
hpdcols <- viridis(3, option = 'D', begin = 0.45)
plot(density((sub_sca$asc1)),main ='',xlab='Fission (MY)',
ylim =c(-10,330), xlim=c(0,0.09))
title(main = "(B)", adj = 0, line = 0.5)
polygon(density(sub_sca$asc1),col=cols[1])
hpd <- HPDinterval(as.mcmc(sub_sca$asc))
y <- -5
lines(y=c(y,y), x=hpd[1:2], lwd=2,col=hpdcols[1])
# lucanidae
lines(density(sub_luc$asc1))
polygon(density(sub_luc$asc1),col=cols[2])
hpd <- HPDinterval(as.mcmc(sub_luc$asc))
y <- -10
lines(y=c(y,y), x=hpd[1:2], lwd=2,col=hpdcols[2])
# passalidae
lines(density((sub_pass$asc1)))
polygon(density(sub_pass$asc1),col=cols[3])
hpd <- HPDinterval(as.mcmc(sub_pass$asc))
y<- -15
lines(y=c(y,y), x=hpd[1:2], lwd=2,col=hpdcols[3])
x = 0.07
cex = 1.2
points(x=x,y=330, col = hpdcols[1], pch= 16,cex = cex )
text(x=x,y=330,pos= 4, "Scarabaeidae", cex=1)
points(x=x,y=315, col = hpdcols[2], pch= 16,cex = cex )
text(x=x,y=315,pos= 4, "Lucanidae", cex=1)
points(x=x,y=300, col = hpdcols[3], pch= 16,cex = cex )
text(x=x,y=300,pos= 4, "Passalidae", cex=1)
allchrom <- read.csv('../data/SpeciesChromList.csv')
trees <- read.tree("../data/final100trees")
tip.names <- trees[[1]]$tip.label
tip.names <- tip.names[grepl('_', tip.names)] # species level only
trees <- keep.tip.multiPhylo(trees, tip.names)
chrom <- data.frame()
# generate chrom data (random pick)
for (j in 1:length(tip.names)){
if (tip.names[j] %in% allchrom$Name){
if (length(which(allchrom$Name == tip.names[j])) == 1){
hitdat <- allchrom[which(allchrom$Name == tip.names[j]),c(1,4,6,8)]
colnames(hitdat) <- c("Family","Species","Chroms","SCS")
chrom <-rbind(chrom, hitdat)
}
if (length(which(allchrom$Name == tip.names[j])) > 1){
pick <- sample(length(which(allchrom$Name == tip.names[j])),1)
hitdat <- allchrom[which(allchrom$Name == tip.names[j])[pick],c(1,4,6,8)]
colnames(hitdat) <- c("Family","Species","Chroms","SCS")
chrom <-rbind(chrom, hitdat)
}
}
}
chrom$SCS <- sub("XXXXXO", "XO", chrom$SCS)
for(i in 1:length(trees)){
trees[[i]]$edge.length <- trees[[i]]$edge.length * 100
}
#
exp <- matrix(NA,nrow = 100, ncol = 100)
obs <-  matrix(NA,nrow = 100, ncol = 100)
for (t in 1:length(trees)){
print(paste0('Tree: ',t))
test <- readRDS(paste0('../results/simmap_species_level/simmap_',t,'.rds'))
counts <- describe.simmap2(test)$count
## AA fusion (desc)
# column that are fusions
need.col <- c()
for (i in 2:rng.len){
need.col <- c(need.col,paste(i,i-1, sep = ','))
}
for (i in 19:(rng.len*2)){
need.col <- c(need.col,paste(i,i-1, sep = ','))
}
for (i in 36:(rng.len*3)){
need.col <- c(need.col,paste(i,i-1, sep = ','))
}
AAfusion <- rowSums(counts[,which(colnames(counts) %in% need.col,T)])
## SAfusion
need.col <- c()
for (i in (rng.len+1+1):(rng.len*2)){
need.col <- c(need.col,paste(i,i-18, sep = ','))
}
for (i in 36:51){
need.col <- c(need.col,paste(i,i-35,sep = ','))
}
for (i in 19:34){
need.col <- c(need.col,paste(i,i+16, sep = ','))
}
SAfusion <- rowSums(counts[,which(colnames(counts) %in% need.col,T)])
totalfusion <- rowSums(counts[,colnames(counts)])
obspropSA <- SAfusion / (SAfusion + AAfusion)
expSA <- c()
for(i in 1:100){
print(i)
times <- describe.simmap(test[[i]])$times[2, ]
expSA[i] <- sum(Pfsa(Da =  6, scs = "XY") * times[c(1, 35)],
Pfsa(Da =  8, scs = "XY") * times[c(2, 36)],
Pfsa(Da = 10, scs = "XY") * times[c(3, 37)],
Pfsa(Da = 12, scs = "XY") * times[c(4, 38)],
Pfsa(Da = 14, scs = "XY") * times[c(5, 39)],
Pfsa(Da = 16, scs = "XY") * times[c(6, 40)],
Pfsa(Da = 18, scs = "XY") * times[c(7, 41)],
Pfsa(Da = 20, scs = "XY") * times[c(8, 42)],
Pfsa(Da = 22, scs = "XY") * times[c(9, 43)],
Pfsa(Da = 24, scs = "XY") * times[c(10, 44)],
Pfsa(Da = 26, scs = "XY") * times[c(11, 45)],
Pfsa(Da = 28, scs = "XY") * times[c(12, 46)],
Pfsa(Da = 30, scs = "XY") * times[c(13, 47)],
Pfsa(Da = 32, scs = "XY") * times[c(14, 48)],
Pfsa(Da = 36, scs = "XY") * times[c(15, 50)],
Pfsa(Da = 38, scs = "XY") * times[c(16, 51)],
#XO
Pfsa(Da =  7, scs = "XO") * times[18],
Pfsa(Da =  9, scs = "XO") * times[19],
Pfsa(Da = 11, scs = "XO") * times[20],
Pfsa(Da = 13, scs = "XO") * times[21],
Pfsa(Da = 15, scs = "XO") * times[22],
Pfsa(Da = 17, scs = "XO") * times[23],
Pfsa(Da = 19, scs = "XO") * times[24],
Pfsa(Da = 21, scs = "XO") * times[25],
Pfsa(Da = 23, scs = "XO") * times[26],
Pfsa(Da = 25, scs = "XO") * times[27],
Pfsa(Da = 27, scs = "XO") * times[28],
Pfsa(Da = 29, scs = "XO") * times[29],
Pfsa(Da = 31, scs = "XO") * times[30],
Pfsa(Da = 33, scs = "XO") * times[31],
Pfsa(Da = 35, scs = "XO") * times[32],
Pfsa(Da = 37, scs = "XO") * times[33],
Pfsa(Da = 39, scs = "XO") * times[34]
)
}
# save the data
exp[,t] <- expSA
obs[,t] <- obspropSA
}
rng <- range(chrom$Chroms)
rng.len <- rng[2]-rng[1]+1
chrom.mat <- matrix(data = 0, nrow = (rng.len*3), ncol = (rng.len*3))
#
exp <- matrix(NA,nrow = 100, ncol = 100)
obs <-  matrix(NA,nrow = 100, ncol = 100)
for (t in 1:length(trees)){
print(paste0('Tree: ',t))
test <- readRDS(paste0('../results/simmap_species_level/simmap_',t,'.rds'))
counts <- describe.simmap2(test)$count
## AA fusion (desc)
# column that are fusions
need.col <- c()
for (i in 2:rng.len){
need.col <- c(need.col,paste(i,i-1, sep = ','))
}
for (i in 19:(rng.len*2)){
need.col <- c(need.col,paste(i,i-1, sep = ','))
}
for (i in 36:(rng.len*3)){
need.col <- c(need.col,paste(i,i-1, sep = ','))
}
AAfusion <- rowSums(counts[,which(colnames(counts) %in% need.col,T)])
## SAfusion
need.col <- c()
for (i in (rng.len+1+1):(rng.len*2)){
need.col <- c(need.col,paste(i,i-18, sep = ','))
}
for (i in 36:51){
need.col <- c(need.col,paste(i,i-35,sep = ','))
}
for (i in 19:34){
need.col <- c(need.col,paste(i,i+16, sep = ','))
}
SAfusion <- rowSums(counts[,which(colnames(counts) %in% need.col,T)])
totalfusion <- rowSums(counts[,colnames(counts)])
obspropSA <- SAfusion / (SAfusion + AAfusion)
expSA <- c()
for(i in 1:100){
print(i)
times <- describe.simmap(test[[i]])$times[2, ]
expSA[i] <- sum(Pfsa(Da =  6, scs = "XY") * times[c(1, 35)],
Pfsa(Da =  8, scs = "XY") * times[c(2, 36)],
Pfsa(Da = 10, scs = "XY") * times[c(3, 37)],
Pfsa(Da = 12, scs = "XY") * times[c(4, 38)],
Pfsa(Da = 14, scs = "XY") * times[c(5, 39)],
Pfsa(Da = 16, scs = "XY") * times[c(6, 40)],
Pfsa(Da = 18, scs = "XY") * times[c(7, 41)],
Pfsa(Da = 20, scs = "XY") * times[c(8, 42)],
Pfsa(Da = 22, scs = "XY") * times[c(9, 43)],
Pfsa(Da = 24, scs = "XY") * times[c(10, 44)],
Pfsa(Da = 26, scs = "XY") * times[c(11, 45)],
Pfsa(Da = 28, scs = "XY") * times[c(12, 46)],
Pfsa(Da = 30, scs = "XY") * times[c(13, 47)],
Pfsa(Da = 32, scs = "XY") * times[c(14, 48)],
Pfsa(Da = 36, scs = "XY") * times[c(15, 50)],
Pfsa(Da = 38, scs = "XY") * times[c(16, 51)],
#XO
Pfsa(Da =  7, scs = "XO") * times[18],
Pfsa(Da =  9, scs = "XO") * times[19],
Pfsa(Da = 11, scs = "XO") * times[20],
Pfsa(Da = 13, scs = "XO") * times[21],
Pfsa(Da = 15, scs = "XO") * times[22],
Pfsa(Da = 17, scs = "XO") * times[23],
Pfsa(Da = 19, scs = "XO") * times[24],
Pfsa(Da = 21, scs = "XO") * times[25],
Pfsa(Da = 23, scs = "XO") * times[26],
Pfsa(Da = 25, scs = "XO") * times[27],
Pfsa(Da = 27, scs = "XO") * times[28],
Pfsa(Da = 29, scs = "XO") * times[29],
Pfsa(Da = 31, scs = "XO") * times[30],
Pfsa(Da = 33, scs = "XO") * times[31],
Pfsa(Da = 35, scs = "XO") * times[32],
Pfsa(Da = 37, scs = "XO") * times[33],
Pfsa(Da = 39, scs = "XO") * times[34]
)
}
# save the data
exp[,t] <- expSA
obs[,t] <- obspropSA
}
View(hpd)
exp
row.names(exp) <- c(1:100)
row.names(obs) <- c(1:100)
colnames(exp) <- paste0("tree", 1:100)
colnames(obs) <- paste0("tree", 1:100)
write.csv(exp, file = '../results/simmap_species_level/exp.csv')
write.csv(obs, file = '../results/simmap_species_level/obs.csv')
# write.csv(exp, file = '../results/simmap_species_level/exp.csv')
# write.csv(obs, file = '../results/simmap_species_level/obs.csv')
# plot
cols <- viridis(2, begin = 0.5, alpha = 0.65)
par(
mfrow = c(5, 5),
mar = c(2, 2, 1.5, 0.5)
)
for (i in 1:100){
plot(density(exp[,i], bw = .01),
xlim = c(.05, 0.5), main = "",
ylim = c(-0.5, 40),
xlab = "Proportion of Sex-Autosome Fusion")
polygon(density(exp[,i], bw = .01),
col = cols[1])
lines(density(obs[,i]))
polygon(density(obs[,i]),
col = cols[2])
exphpd <- HPDinterval(as.mcmc(exp[,i]))
obshpd <- HPDinterval(as.mcmc(obs[,i]))
exp_min <- min(exphpd)
exp_max <- max(exphpd)
obs_min <- min(obshpd)
obs_max <- max(obshpd)
# overlap and observe mean < exp mean
no_overlap_flag <- exp_max < obs_min || obs_max < exp_min
mean_less_flag <- mean(exphpd, na.rm = TRUE) < mean(obshpd, na.rm = TRUE)
exceed <- c(exceed,no_overlap_flag && mean_less_flag)
}
exceed <- c()
for (i in 1:100){
plot(density(exp[,i], bw = .01),
xlim = c(.05, 0.5), main = "",
ylim = c(-0.5, 40),
xlab = "Proportion of Sex-Autosome Fusion")
polygon(density(exp[,i], bw = .01),
col = cols[1])
lines(density(obs[,i]))
polygon(density(obs[,i]),
col = cols[2])
exphpd <- HPDinterval(as.mcmc(exp[,i]))
obshpd <- HPDinterval(as.mcmc(obs[,i]))
exp_min <- min(exphpd)
exp_max <- max(exphpd)
obs_min <- min(obshpd)
obs_max <- max(obshpd)
# overlap and observe mean < exp mean
no_overlap_flag <- exp_max < obs_min || obs_max < exp_min
mean_less_flag <- mean(exphpd, na.rm = TRUE) < mean(obshpd, na.rm = TRUE)
exceed <- c(exceed,no_overlap_flag && mean_less_flag)
}
sum(exceed)
for (i in 1:100){
plot(density(exp[,i], bw = .01),
xlim = c(.05, 0.7), main = "",
ylim = c(-0.5, 40),
xlab = "Proportion of Sex-Autosome Fusion")
polygon(density(exp[,i], bw = .01),
col = cols[1])
lines(density(obs[,i]))
polygon(density(obs[,i]),
col = cols[2])
exphpd <- HPDinterval(as.mcmc(exp[,i]))
obshpd <- HPDinterval(as.mcmc(obs[,i]))
exp_min <- min(exphpd)
exp_max <- max(exphpd)
obs_min <- min(obshpd)
obs_max <- max(obshpd)
# overlap and observe mean < exp mean
no_overlap_flag <- exp_max < obs_min || obs_max < exp_min
mean_less_flag <- mean(exphpd, na.rm = TRUE) < mean(obshpd, na.rm = TRUE)
exceed <- c(exceed,no_overlap_flag && mean_less_flag)
}
par(
mfrow = c(5, 5),
mar = c(2, 2, 1.5, 0.5)
)
exceed <- c()
for (i in 1:100){
plot(density(exp[,i], bw = .01),
xlim = c(.05, 0.7), main = "",
ylim = c(-0.5, 40),
xlab = "Proportion of Sex-Autosome Fusion")
polygon(density(exp[,i], bw = .01),
col = cols[1])
lines(density(obs[,i]))
polygon(density(obs[,i]),
col = cols[2])
exphpd <- HPDinterval(as.mcmc(exp[,i]))
obshpd <- HPDinterval(as.mcmc(obs[,i]))
exp_min <- min(exphpd)
exp_max <- max(exphpd)
obs_min <- min(obshpd)
obs_max <- max(obshpd)
# overlap and observe mean < exp mean
no_overlap_flag <- exp_max < obs_min || obs_max < exp_min
mean_less_flag <- mean(exphpd, na.rm = TRUE) < mean(obshpd, na.rm = TRUE)
exceed <- c(exceed,no_overlap_flag && mean_less_flag)
}
sum(exceed)
par(
mfrow = c(5, 5),
mar = c(2, 2, 1.5, 0.5)
)
exceed <- c()
for (i in 1:100){
plot(density(exp[,i], bw = .01),
xlim = c(.05, 0.9), main = "",
ylim = c(-0.5, 40),
xlab = "Proportion of Sex-Autosome Fusion")
polygon(density(exp[,i], bw = .01),
col = cols[1])
lines(density(obs[,i]))
polygon(density(obs[,i]),
col = cols[2])
exphpd <- HPDinterval(as.mcmc(exp[,i]))
obshpd <- HPDinterval(as.mcmc(obs[,i]))
exp_min <- min(exphpd)
exp_max <- max(exphpd)
obs_min <- min(obshpd)
obs_max <- max(obshpd)
# overlap and observe mean < exp mean
no_overlap_flag <- exp_max < obs_min || obs_max < exp_min
mean_less_flag <- mean(exphpd, na.rm = TRUE) < mean(obshpd, na.rm = TRUE)
exceed <- c(exceed,no_overlap_flag && mean_less_flag)
}
